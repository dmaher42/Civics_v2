<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head><
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Vibe vs. The Text: Australia's Constitution — COMPLETING THIS ACTIVITY GETS US A PE LESSON ON THURSDAY</title>
  <meta name="description" content="Class activity pack + game: explore the 'vibe' people expect from a constitution vs the actual text of Australia's Constitution." />

  <!-- Fonts & Tailwind (no build step required) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        container: { center: true, padding: '1rem' },
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'Segoe UI', 'Roboto', 'sans-serif'] },
          colors: {
            brand: {50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',800:'#1e40af',900:'#1e3a8a'}
          },
          boxShadow: { soft: '0 10px 30px rgba(2, 6, 23, 0.08)' }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .lift { transition: transform .18s ease, box-shadow .18s ease; }
    .lift:hover { transform: translateY(-4px); box-shadow: 0 24px 40px rgba(2,6,23,.12); }
    @media (prefers-reduced-motion: reduce) { .lift { transition: none; } }

    /* Primary navigation */
    .site-nav {
      display:flex;
      align-items:center;
      gap:1.25rem;
      justify-content:flex-start;
      padding:.75rem 0;
      position:relative;
      z-index:30;
    }
    .site-nav .brand {
      display:inline-flex;
      align-items:center;
      gap:.75rem;
      font-weight:700;
      text-decoration:none;
      color:#111;
    }
    .site-nav .brand-mark {
      width:2rem;
      height:2rem;
      border-radius:.9rem;
      background:linear-gradient(135deg,#3b82f6,#2563eb);
      flex-shrink:0;
    }
    .site-nav .brand-text {
      font-weight:800;
      letter-spacing:-.01em;
    }
    .nav-toggle {
      display:none;
      background:none;
      border:1px solid #ddd;
      padding:.35rem .6rem;
      border-radius:.5rem;
      cursor:pointer;
      font-size:1.25rem;
      line-height:1;
    }
    .nav-links {
      display:flex;
      align-items:center;
      gap:1rem;
      list-style:none;
      margin:0;
      padding:0;
      margin-left:auto;
    }
    .nav-links > li {
      position:relative;
      display:flex;
      align-items:center;
    }
    .nav-links a {
      text-decoration:none;
      color:#222;
      padding:.4rem .65rem;
      border-radius:.4rem;
      font-weight:500;
    }
    .nav-links a:hover {
      background:#f2f2f2;
    }
    .unit-of-work {
      display:flex;
      align-items:center;
    }
    .unit-of-work .unit-next{
      background:#111;
      color:#fff;
      border:none;
      border-radius:.5rem;
      padding:.5rem .8rem;
      cursor:pointer;
      font:inherit;
      display:inline-flex;
      align-items:center;
      gap:.35rem;
    }
    .unit-of-work .unit-next:hover{ opacity:.9; }
    .dark .unit-of-work .unit-next{
      background:#1e293b;
      color:#f8fafc;
    }
    .dark .unit-of-work .unit-next:hover{
      background:#0f172a;
    }
    .nav-links > .nav-utilities {
      display:flex;
      align-items:center;
      gap:.75rem;
      margin-left:1rem;
    }
    .nav-links > .nav-utilities .nav-auth {
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .nav-links > .nav-utilities .theme-toggle { flex-shrink:0; }
    @media (max-width: 820px) {
      .site-nav { flex-wrap:wrap; }
      .nav-toggle {
        display:inline-flex;
        align-items:center;
        justify-content:center;
      }
      .nav-links {
        position:absolute;
        top:100%;
        left:0;
        right:0;
        background:#fff;
        border-bottom:1px solid #e6e6e6;
        flex-direction:column;
        align-items:stretch;
        gap:.25rem;
        padding:.75rem 1rem 1rem;
        display:none;
        z-index:50;
      }
      .nav-links.open { display:flex; }
      .nav-links > li { width:100%; }
      .nav-links a,
      .unit-of-work .unit-next { width:100%; }
      .nav-links > .nav-utilities {
        flex-direction:column;
        align-items:stretch;
        gap:.75rem;
        padding-top:.75rem;
        margin-top:.5rem;
        border-top:1px solid #e6e6e6;
      }
      .nav-links > .nav-utilities .nav-auth {
        flex-direction:column;
        align-items:stretch;
      }
      .nav-links > .nav-utilities .nav-auth button { width:100%; }
      .nav-links > .nav-utilities .theme-toggle { align-self:flex-start; }
      .dark .nav-links {
        background:#0f172a;
        border-color:rgba(148,163,184,.35);
      }
      .dark .nav-links > .nav-utilities {
        border-top-color:rgba(148,163,184,.35);
      }
    }
    .dark .site-nav .brand,
    .dark .nav-links a {
      color:#f1f5f9;
    }
    .dark .nav-links a:hover {
      background:rgba(148,163,184,.2);
    }

    .activity-card{
      background:linear-gradient(135deg,rgba(219,234,254,.55),rgba(248,250,252,.92));
      border-radius:1rem;padding:1.5rem;margin-bottom:1.25rem;
      box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);
      border:1px solid rgba(226,232,240,.9);backdrop-filter:blur(6px)
    }
    #game{background:linear-gradient(135deg,rgba(255,255,255,.88),rgba(219,234,254,.7));border:1px solid rgba(191,219,254,.8);backdrop-filter:blur(8px);box-shadow:0 20px 40px rgba(15,23,42,.08)}
    .dark #game{background:rgba(15,23,42,.7);border-color:rgba(148,163,184,.45);box-shadow:none}

    /* Writing panels (Activity 2 & 3) */
    .writing-panel{display:flex;flex-direction:column;gap:.75rem;background:rgba(255,255,255,.92);border-radius:1rem;border:1px solid rgba(148,163,184,.4);padding:1.25rem;box-shadow:0 14px 30px rgba(15,23,42,.08);color:#1e3a8a}
    .dark .writing-panel{background:rgba(15,23,42,.72);border-color:rgba(148,163,184,.35);box-shadow:none;color:#e0e7ff}
    .writing-panel--accent{background:linear-gradient(135deg,rgba(196,181,253,.25),rgba(219,234,254,.24));border-color:rgba(168,85,247,.45)}
    .dark .writing-panel--accent{background:rgba(76,29,149,.45);border-color:rgba(168,85,247,.55)}
    .writing-panel--no-storage{border-color:rgba(249,115,22,.55)}
    .writing-panel__title{font-weight:700;font-size:1.05rem;letter-spacing:-.01em}
    .writing-panel textarea{width:100%;min-height:150px;resize:vertical;border:1px solid rgba(148,163,184,.6);border-radius:.85rem;padding:.85rem 1rem;font:inherit;background-color:rgba(248,250,252,.94);color:inherit}
    .writing-panel textarea:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15);background-color:#fff}
    .dark .writing-panel textarea{background-color:rgba(15,23,42,.65);border-color:rgba(148,163,184,.45)}
    .writing-panel__footer{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:.75rem;font-size:.875rem}
    .writing-panel__status[data-state="success"]{color:#15803d}
    .writing-panel__status[data-state="info"]{color:#0369a1}
    .writing-panel__status[data-state="error"]{color:#b91c1c}
    .writing-panel__status[data-state="saving"]{color:#2563eb}
    .writing-panel__status[data-state="muted"]{color:#475569}
    .writing-panel__reset{border:1px solid rgba(148,163,184,.6);border-radius:9999px;padding:.35rem .85rem;font-size:.85rem;font-weight:600;color:#2563eb;background:#fff}
    .writing-panel__reset:hover{background:#dbeafe}
  </style>
</head>
<body class="bg-gray-50 text-slate-800 antialiased dark:bg-slate-950 dark:text-slate-100">
  <!-- Skip link -->
  <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 bg-brand-600 text-white px-3 py-2 rounded-lg">Skip to content</a>

  <!-- Top ribbon -->
  <div class="bg-gradient-to-r from-brand-600 to-brand-400 text-white text-sm">
    <div class="container py-2 text-center">
      New classroom-ready version with a game! <a class="underline font-semibold" href="#activity-4">Jump to Game</a>
    </div>
  </div>

  <!-- Header / Nav -->
  <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:supports-[backdrop-filter]:bg-slate-900/70 border-b border-slate-200/60 dark:border-slate-800">
    <div class="container">
      <nav class="site-nav">
        <a class="brand" href="#overview">
          <span class="brand-mark" aria-hidden="true"></span>
          <span class="brand-text">Civics Toolkit</span>
        </a>
        <a href="dashboard.html">Unit Dashboard</a>
        <button class="nav-toggle" aria-label="Toggle menu" aria-expanded="false">
          ☰
        </button>

        <ul class="nav-links" data-collapsible>
          <li><a href="#overview">Overview</a></li>

          <li class="unit-of-work">
            <button class="unit-next" id="unit-next" aria-label="Go to next lesson">
              Unit of Work ▶
            </button>
          </li>

          <li><a href="#resources">Resources</a></li>
          <li><a href="#save-online">Save Online</a></li>

          <li class="nav-utilities" role="none">
            <div id="authArea" class="nav-auth flex items-center gap-2" role="none">
              <button id="googleLoginTop"
                      class="px-3 py-2 rounded-lg bg-brand-600 text-white font-semibold hover:opacity-90">
                Sign in with Google
              </button>
              <button id="signOutTop"
                      class="hidden px-3 py-2 rounded-lg border border-slate-300 text-sm hover:bg-slate-50">
                Sign out
              </button>
            </div>
            <button id="themeToggle" class="theme-toggle p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Toggle dark mode">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5"><path d="M21.75 15.002A9.72 9.72 0 0 1 12.004 22C6.487 22 2 17.513 2 11.996 2 7.45 4.94 3.61 9.06 2.248a.75.75 0 0 1 .935.966 8.25 8.25 0 0 0 10.73 10.73.75.75 0 0 1 1.027.958Z"/></svg>
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <section id="overview" class="relative overflow-hidden">
    <div class="absolute inset-0 -z-10 bg-gradient-to-b from-white via-brand-50 to-white dark:from-slate-950 dark:via-slate-900 dark:to-slate-950"></div>
    <div class="container grid md:grid-cols-2 gap-10 py-14 md:py-20 items-center">
      <div>
        <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight leading-[1.05]">🏛️ The Vibe vs. The Text</h1>
        <p class="mt-4 text-lg text-slate-600 dark:text-slate-300">Exploring Australia's Constitution: compare what people expect a constitution to be with what the 1901 document actually says.</p>
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#activity-1" class="inline-flex items-center rounded-xl bg-brand-600 px-5 py-3 text-white font-semibold shadow-soft hover:opacity-90">Start Activity</a>
          <a href="#resources" class="inline-flex items-center rounded-xl border border-slate-300 dark:border-slate-700 px-5 py-3 font-semibold hover:bg-slate-50 dark:hover:bg-slate-800">Teacher Resources</a>
          <a href="#activity-4" class="inline-flex items-center rounded-xl bg-purple-600 px-5 py-3 text-white font-semibold shadow-soft hover:opacity-90">Play Game</a>
        </div>
        <div class="mt-8 max-w-xl rounded-2xl border border-slate-200/80 bg-white/70 p-6 shadow-soft backdrop-blur dark:border-slate-800 dark:bg-slate-900/60">
          <p class="text-sm font-semibold uppercase tracking-wide text-brand-700 dark:text-brand-200">Lesson Snapshot</p>
          <dl class="mt-4 grid grid-cols-1 gap-4 text-sm sm:grid-cols-3">
            <div>
              <dt class="font-semibold text-slate-700 dark:text-slate-200">Year levels</dt>
              <dd class="text-slate-600 dark:text-slate-300">Designed for Years 9–10, adaptable 7–12.</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-700 dark:text-slate-200">Time needed</dt>
              <dd class="text-slate-600 dark:text-slate-300">Approx. 2 × 50-minute lessons.</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-700 dark:text-slate-200">Focus</dt>
              <dd class="text-slate-600 dark:text-slate-300">Comparing constitutional “vibes” with the actual text.</dd>
            </div>
          </dl>
          <p class="mt-4 text-sm text-slate-600 dark:text-slate-300">Everything you need to spark discussion—videos, collaborative whiteboards, writing prompts, and a friendly quiz game.</p>
        </div>
      </div>
      <div>
        <div class="relative">
          <div class="absolute -inset-4 -z-10 rounded-3xl bg-gradient-to-tr from-brand-200 to-brand-500 blur-3xl opacity-30"></div>
          <div class="rounded-3xl border border-slate-200 dark:border-slate-800 bg-white/60 dark:bg-slate-900/60 p-2 shadow-soft backdrop-blur">
            <img src="https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1600&auto=format&fit=crop" alt="Students collaborating on civics activity" class="rounded-2xl"/>
          </div>
        </div>
      </div>
    </div>
  </section>

  <main id="main" class="container px-4 md:px-0">
    <!-- Intro -->
    <section aria-labelledby="intro-title" class="max-w-3xl mx-auto mb-12">
      <div class="bg-white/90 dark:bg-slate-900/70 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-800">
        <h2 id="intro-title" class="text-2xl font-extrabold mb-4 text-center">What's the "Vibe" of the Constitution?</h2>
        <p class="mb-4 text-slate-700 dark:text-slate-300">We often have a feeling about what a nation's most important document should do—fairness, rights, big principles. Watch this classic moment from <em>The Castle</em>.</p>
        <div class="relative w-full rounded-xl overflow-hidden border border-slate-200 dark:border-slate-800">
          <div class="pt-[56.25%]"></div>
          <iframe class="absolute inset-0 w-full h-full" src="https://www.youtube-nocookie.com/embed/97IiPli_uXw" title="The Castle clip" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy" referrerpolicy="strict-origin-when-cross-origin"></iframe>
        </div>
        <p class="mt-4 text-slate-700 dark:text-slate-300">Then compare that vibe to the actual text of Australia's Constitution (1901). Let's investigate.</p>
      </div>
    </section>

    <section id="portfolio" class="activity-card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-extrabold">📁 Portfolio — Unit Work</h2>
        <span id="portfolioStatus" class="text-sm text-slate-500">Not signed in</span>
      </div>

      <!-- Unit / Week selectors -->
      <div class="flex flex-wrap items-center gap-2 mb-4">
        <label class="text-sm">
          Unit:
          <select id="pfUnit" class="ml-2 rounded-lg border border-slate-300 p-2">
            <option value="civics-constitution-2025">Civics: Australia’s Constitution (2025)</option>
          </select>
        </label>
        <div id="pfWeeks" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Prompts for the selected week -->
      <div id="pfPrompts" class="grid gap-3"></div>

      <!-- Uploads -->
      <div class="mt-4">
        <h3 class="font-semibold mb-2">Attachments</h3>
        <div class="flex flex-wrap items-center gap-2 mb-2">
          <input id="pfFile" type="file" multiple accept="image/*,application/pdf" class="block text-sm" />
          <button id="pfUpload" class="px-3 py-2 rounded-lg border border-slate-300 text-sm">Upload</button>
        </div>
        <ul id="pfFiles" class="list-disc list-inside text-sm text-slate-700"></ul>
      </div>
    </section>

    <!-- Activity 1: Whiteboard “Big Paper” (same-origin embed) -->
    <section id="activity-1" class="activity-card">
      <div class="flex items-start">
        <div class="mr-4 shrink-0">
          <div class="h-10 w-10 rounded-xl grid place-items-center bg-brand-100 text-brand-700 font-bold">1</div>
        </div>
        <div class="w-full">
          <h2 class="text-2xl font-extrabold mb-3">The “Big Paper” Brainstorm 🤔</h2>
          <p class="mb-4 text-lg">Use the class whiteboard to silently add ideas: key rules for fairness, limits on government, and rights to protect.</p>

          <!-- Activity 1 Whiteboard (same-origin iframe) -->
          <div class="h-[640px] rounded-lg overflow-hidden border">
            <!-- NOTE: use a RELATIVE path so it works on GitHub Pages project sites -->
            <iframe
              id="classWhiteboard"
              src="./whiteboard/"
              title="Class Whiteboard"
              class="w-full h-full"
              allow="clipboard-read; clipboard-write"
              referrerpolicy="no-referrer"
            ></iframe>
          </div>

          <script>
            // Optional: tiny load check + fallback link
            const wb = document.getElementById('classWhiteboard');
            const fallback = document.createElement('p');
            fallback.className = 'mt-2 text-sm text-slate-600';
            fallback.innerHTML = 'If the whiteboard does not appear, <a class="underline" target="_blank" rel="noopener" href="./whiteboard/">open it in a new tab</a>.';
            wb.addEventListener('load', () => wb.insertAdjacentElement('afterend', fallback));
          </script>

          <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
            Tip: Use the class whiteboard to capture every idea. Writing only — no talking!
          </p>
        </div>
      </div>
    </section>

    <!-- Activity 2 -->
    <section id="activity-2" class="activity-card">
      <div class="flex items-start">
        <div class="mr-4 shrink-0">
          <div class="h-10 w-10 rounded-xl grid place-items-center bg-brand-100 text-brand-700 font-bold">2</div>
        </div>
        <div>
          <h2 class="text-2xl font-extrabold mb-3">Unpacking the Real Deal 🎬</h2>
          <p class="mb-4">Watch the Parliamentary Education Office video, then identify five key concepts.</p>
          <div class="relative w-full rounded-xl overflow-hidden border border-slate-200 dark:border-slate-800 mb-6 bg-black">
            <video controls class="block w-full h-auto" preload="metadata">
              <source src="https://aphref.aph.gov.au/senate/Video/PEO/PEO-The-Constitution.mp4#t=0.1" type="video/mp4" />
              Your browser does not support the video tag.
            </video>
          </div>
          <h3 class="text-xl font-extrabold mb-3">Five-Finger Summaries 🖐️</h3>
          <p class="mb-4">Use the shared writing panels below to capture what each idea means in the Australian Constitution.</p>

          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <article class="writing-panel" data-writing-panel data-storage-key="five-separation">
              <div>
                <h4 id="separation-title" class="writing-panel__title">Separation of Powers</h4>
                <p id="prompt-separation" class="text-sm">Summarise how the Constitution divides law-making, enforcing, and interpreting powers between Parliament, the Executive, and the High Court. Aim for 30–50 words.</p>
              </div>
              <label class="sr-only" for="summary-separation">Write a summary for Separation of Powers</label>
              <textarea id="summary-separation" data-writing-input rows="5" aria-labelledby="separation-title" aria-describedby="prompt-separation" placeholder="Which branch does what? Include one detail or example from the video."></textarea>
              <div class="writing-panel__footer">
                <p class="writing-panel__status" data-writing-status aria-live="polite">Autosave ready.</p>
                <div class="writing-panel__actions">
                  <span class="writing-panel__count" data-writing-count>0 words</span>
                  <button type="button" class="writing-panel__reset" data-writing-reset>Reset</button>
                </div>
              </div>
            </article>

            <article class="writing-panel" data-writing-panel data-storage-key="five-division">
              <div>
                <h4 id="division-title" class="writing-panel__title">Division of Powers</h4>
                <p id="prompt-division" class="text-sm">Explain how national and state governments split responsibilities. Name at least one Commonwealth power from the video. Aim for 30–50 words.</p>
              </div>
              <label class="sr-only" for="summary-division">Write a summary for Division of Powers</label>
              <textarea id="summary-division" data-writing-input rows="5" aria-labelledby="division-title" aria-describedby="prompt-division" placeholder="What does the Commonwealth control? What stays with the states?"></textarea>
              <div class="writing-panel__footer">
                <p class="writing-panel__status" data-writing-status aria-live="polite">Autosave ready.</p>
                <div class="writing-panel__actions">
                  <span class="writing-panel__count" data-writing-count>0 words</span>
                  <button type="button" class="writing-panel__reset" data-writing-reset>Reset</button>
                </div>
              </div>
            </article>

            <article class="writing-panel" data-writing-panel data-storage-key="five-rule">
              <div>
                <h4 id="rule-title" class="writing-panel__title">The Rule of Law</h4>
                <p id="prompt-rule" class="text-sm">Describe what the rule of law means in Australia and how the Constitution protects it. Aim for 30–50 words.</p>
              </div>
              <label class="sr-only" for="summary-rule">Write a summary for the Rule of Law</label>
              <textarea id="summary-rule" data-writing-input rows="5" aria-labelledby="rule-title" aria-describedby="prompt-rule" placeholder="Who must follow the law? Mention any safeguards or courts that enforce it."></textarea>
              <div class="writing-panel__footer">
                <p class="writing-panel__status" data-writing-status aria-live="polite">Autosave ready.</p>
                <div class="writing-panel__actions">
                  <span class="writing-panel__count" data-writing-count>0 words</span>
                  <button type="button" class="writing-panel__reset" data-writing-reset>Reset</button>
                </div>
              </div>
            </article>

            <article class="writing-panel" data-writing-panel data-storage-key="five-representative">
              <div>
                <h4 id="representative-title" class="writing-panel__title">Representative &amp; Responsible Government</h4>
                <p id="prompt-representative" class="text-sm">Outline how elections and accountability keep leaders answerable to the people. Include one example from the video. Aim for 30–50 words.</p>
              </div>
              <label class="sr-only" for="summary-representative">Write a summary for Representative and Responsible Government</label>
              <textarea id="summary-representative" data-writing-input rows="5" aria-labelledby="representative-title" aria-describedby="prompt-representative" placeholder="How are members chosen? How must the government answer to Parliament?"></textarea>
              <div class="writing-panel__footer">
                <p class="writing-panel__status" data-writing-status aria-live="polite">Autosave ready.</p>
                <div class="writing-panel__actions">
                  <span class="writing-panel__count" data-writing-count>0 words</span>
                  <button type="button" class="writing-panel__reset" data-writing-reset>Reset</button>
                </div>
              </div>
            </article>

            <article class="writing-panel md:col-span-2" data-writing-panel data-storage-key="five-rights">
              <div>
                <h4 id="rights-title" class="writing-panel__title">Rights in the Constitution</h4>
                <p id="prompt-rights" class="text-sm">Identify the specific rights named in the Constitution and note any limits or rights that are missing. Aim for 40–60 words.</p>
              </div>
              <label class="sr-only" for="summary-rights">Write a summary for Rights in the Constitution</label>
              <textarea id="summary-rights" data-writing-input rows="5" aria-labelledby="rights-title" aria-describedby="prompt-rights" placeholder="Which rights are explicit? Which did you expect but not find?"></textarea>
              <div class="writing-panel__footer">
                <p class="writing-panel__status" data-writing-status aria-live="polite">Autosave ready.</p>
                <div class="writing-panel__actions">
                  <span class="writing-panel__count" data-writing-count>0 words</span>
                  <button type="button" class="writing-panel__reset" data-writing-reset>Reset</button>
                </div>
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>

    <!-- Activity 3 -->
    <section id="activity-3" class="activity-card">
      <div class="flex items-start">
        <div class="mr-4 shrink-0">
          <div class="h-10 w-10 rounded-xl grid place-items-center bg-brand-100 text-brand-700 font-bold">3</div>
        </div>
        <div>
          <h2 class="text-2xl font-extrabold mb-3">Vibe vs. Text Showdown ⚖️</h2>
          <p class="mb-4">Compare your Big Paper ideas with what you learned from the video.</p>
          <h3 class="font-semibold mb-2">Guiding Questions</h3>
          <ul class="list-disc list-inside space-y-2 text-slate-700 dark:text-slate-300">
            <li><strong>What's missing?</strong> Ideas from your class that are not in the video (e.g., bill of rights, PM mention, environment).</li>
            <li><strong>What's surprising?</strong> Anything unexpected—how much is mechanics of government vs rights?</li>
            <li><strong>Why the gap?</strong> Consider the 1901 context and the goal of uniting six colonies.</li>
          </ul>
          <div class="mt-6">
            <article class="writing-panel writing-panel--accent" data-writing-panel data-storage-key="showdown-reflection">
              <div>
                <h3 id="showdown-title" class="writing-panel__title">Showdown Reflection Paragraph</h3>
                <p id="prompt-showdown" class="text-sm">Use the guiding questions to craft a concluding paragraph that compares the class "vibe" with the constitutional text. Aim for four to five sentences.</p>
                <ol id="showdown-steps" class="list-decimal list-inside space-y-1 text-sm text-slate-600 dark:text-slate-200 mt-2">
                  <li>Start with a topic sentence that states the contrast.</li>
                  <li>Include one detail from your Big Paper ideas and one from the video.</li>
                  <li>Explain why the differences exist in the 1901 context.</li>
                  <li>Finish with what this teaches about constitutions today.</li>
                </ol>
              </div>
              <label class="sr-only" for="showdown-reflection">Write your concluding paragraph</label>
              <textarea id="showdown-reflection" data-writing-input rows="7" aria-labelledby="showdown-title" aria-describedby="prompt-showdown showdown-steps" placeholder="Although we expected the Constitution to…, the text actually…, because…. This shows…"></textarea>
              <div class="writing-panel__footer">
                <p class="writing-panel__status" data-writing-status aria-live="polite">Autosave ready.</p>
                <div class="writing-panel__actions">
                  <span class="writing-panel__count" data-writing-count>0 words</span>
                  <button type="button" class="writing-panel__reset" data-writing-reset>Reset</button>
                </div>
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>

    <!-- Activity 4: Constitution Game -->
    <section id="activity-4" class="activity-card">
      <div class="flex items-start">
        <div class="mr-4 shrink-0">
          <div class="h-10 w-10 rounded-xl grid place-items-center bg-brand-100 text-brand-700 font-bold">4</div>
        </div>
        <div class="flex-1">
          <h2 class="text-2xl font-extrabold mb-3">Constitution Game 🎮</h2>
          <p class="mb-4">Decide if each statement is part of the actual <strong>Text</strong> of the Constitution or just the <strong>Vibe</strong>.</p>
          <div id="game" class="max-w-xl mx-auto bg-white rounded-xl shadow p-6 border border-gray-200">
            <div id="question" class="text-lg font-medium text-center mb-4 text-black dark:text-black"></div>
            <div class="flex justify-center gap-4 mb-4">
              <button onclick="answer('vibe')" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:opacity-90">Vibe</button>
              <button onclick="answer('text')" class="px-4 py-2 rounded-lg bg-green-600 text-white font-semibold hover:opacity-90">Text</button>
            </div>
            <div id="feedback" class="text-center text-sm mb-4"></div>
            <div class="flex justify-between items-center">
              <div id="score" class="font-semibold text-gray-700"></div>
              <button id="nextBtn" onclick="nextQuestion()" class="hidden px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:opacity-90">Next →</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Save online + teacher dashboard -->
    <!-- SAVE ONLINE (Students) -->
    <section id="save-online" class="activity-card">
      <div class="flex items-start gap-4">
        <div class="h-10 w-10 rounded-xl grid place-items-center bg-emerald-100 text-emerald-700 font-bold">☁︎</div>
        <div class="flex-1">
          <h2 class="text-2xl font-extrabold mb-1">Save Your Work Online</h2>
          <p class="text-sm text-slate-600 mb-3">Sign in, then your writing panels and game score will auto-save every few seconds.</p>

          <div class="flex flex-wrap items-center gap-2 mb-3">
            <button id="googleLogin" class="px-3 py-2 rounded-xl bg-brand-600 text-white">Sign in with Google</button>
            <button id="signOut" class="hidden px-3 py-2 rounded-xl border border-slate-300">Sign out</button>
            <span id="fbStatus" class="ml-auto text-sm text-slate-600">Not signed in</span>
          </div>

          <div class="grid sm:grid-cols-2 gap-3">
            <label class="text-sm">Your name
              <input id="studentName" class="mt-1 w-full rounded-lg border border-slate-300 p-2" placeholder="e.g., Jordan Smith" />
            </label>
            <label class="text-sm">Class / Home group
              <input id="studentClass" class="mt-1 w-full rounded-lg border border-slate-300 p-2" placeholder="e.g., 10A" />
            </label>
          </div>

          <div class="mt-3 flex gap-2">
            <button id="saveNow" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Save now</button>
            <span id="saveHint" class="text-sm text-slate-500">Autosaves while you type.</span>
          </div>
        </div>
      </div>
    </section>

    <!-- TEACHER DASHBOARD -->
    <section id="teacher-dash" class="activity-card hidden">
      <h3 class="text-xl font-extrabold mb-2">Teacher Dashboard — Latest Submissions</h3>
      <div id="dashInfo" class="text-sm text-slate-600 mb-2"></div>
      <div class="overflow-auto border border-slate-200 rounded-lg">
        <table class="min-w-[640px] w-full text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="text-left p-2">Name</th>
              <th class="text-left p-2">Class</th>
              <th class="text-left p-2">Email</th>
              <th class="text-left p-2">Updated</th>
              <th class="text-left p-2">Score</th>
              <th class="text-left p-2">Open</th>
            </tr>
          </thead>
          <tbody id="dashRows"></tbody>
        </table>
      </div>
    </section>

    <!-- Footer -->
    <footer id="resources" class="text-center mt-12">
      <h2 class="text-xl font-bold mb-4">📚 Resources</h2>
      <div class="flex justify-center space-x-4 text-blue-600 hover:text-blue-800">
        <a href="https://peo.gov.au/understand-our-parliament/how-parliament-works/the-australian-constitution/the-australian-constitution-video/" target="_blank" rel="noopener">PEO Video Page</a>
        <span class="text-gray-400">|</span>
        <a href="https://www.facinghistory.org/resource-library/big-paper" target="_blank" rel="noopener">"Big Paper" Strategy</a>
        <span class="text-gray-400">|</span>
        <a href="https://peo.gov.au/understand-our-parliament/how-parliament-works/the-australian-constitution/the-constitution" target="_blank" rel="noopener">Full Text of the Constitution</a>
      </div>
      <p class="text-sm text-gray-500 mt-4">© <span id="year"></span> Civics Toolkit</p>
    </footer>
  </main>

  <!-- ===== Scripts ===== -->

  <!-- Nav + Dark mode + Footer year -->
  <script>
    (function () {
      const nav = document.querySelector('.site-nav');
      const navToggle = nav?.querySelector('.nav-toggle');
      const navLinks = nav?.querySelector('.nav-links');

      function setNavOpen(open) {
        if (!navLinks) return;
        navLinks.classList.toggle('open', open);
        navToggle?.setAttribute('aria-expanded', String(open));
      }

      navToggle?.addEventListener('click', (event) => {
        event.stopPropagation();
        const open = !navLinks?.classList.contains('open');
        setNavOpen(open);
      });

      navLinks?.addEventListener('click', (event) => {
        const target = event.target instanceof Element ? event.target.closest('a, button') : null;
        if (target && navLinks?.classList.contains('open')) setNavOpen(false);
      });

      document.addEventListener('click', (event) => {
        if (nav && navLinks?.classList.contains('open') && !nav.contains(event.target)) {
          setNavOpen(false);
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          setNavOpen(false);
        }
      });
    })();

    (function () {
      const toggle = document.getElementById('themeToggle');
      const root = document.documentElement;
      const KEY = 'theme';
      let savedTheme = null;
      try {
        savedTheme = localStorage.getItem(KEY);
      } catch (err) {
        savedTheme = null;
      }
      if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        root.classList.add('dark');
      }
      toggle?.addEventListener('click', () => {
        root.classList.toggle('dark');
        try {
          localStorage.setItem(KEY, root.classList.contains('dark') ? 'dark' : 'light');
        } catch (err) {
          /* ignore */
        }
      });
    })();

    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();
  </script>

  <script>
    const LESSONS = [
      { title: "Portfolio Hub", url: "index.html#portfolio" },
      { title: "Activity 1: Whiteboard", url: "whiteboard/index.html" },
      { title: "Activity 2: Video + Reflection", url: "index.html#activity-2" },
      { title: "Activity 3: Reflection Panel", url: "index.html#activity-3" },
      { title: "Activity 4: Constitution Game", url: "index.html#activity-4" }
    ];

    function normalize(href) {
      const u = new URL(href, window.location.href);
      return u.pathname.replace(/\/+$/, "") + (u.hash || "");
    }

    function getCurrentLessonIndex() {
      const here = normalize(window.location.pathname + window.location.hash);
      let idx = LESSONS.findIndex((lesson) => normalize(lesson.url) === here);
      if (idx !== -1) return idx;

      const herePath = normalize(window.location.pathname);
      idx = LESSONS.findIndex((lesson) => normalize(lesson.url).split("#")[0] === herePath);
      return idx;
    }

    function goToNextLesson() {
      let idx = getCurrentLessonIndex();
      if (idx === -1) {
        window.location.href = LESSONS[0].url;
        return;
      }
      const next = idx + 1;
      if (next < LESSONS.length) {
        window.location.href = LESSONS[next].url;
      } else {
        alert("You’ve reached the end of the unit 👏");
      }
    }

    document.getElementById('unit-next')?.addEventListener('click', goToNextLesson);
  </script>

  <!-- Writing panels autosave -->
  <script>
    (function(){
      const panels = Array.from(document.querySelectorAll('[data-writing-panel]'));
      if (!panels.length) return;

      const storagePrefix = 'civics-writing-panel-';
      let storageAvailable = true, storage;

      try {
        storage = window.localStorage;
        const k = storagePrefix + 'probe';
        storage.setItem(k, 'ok'); storage.removeItem(k);
      } catch { storageAvailable = false; storage = null; }

      const watchers = [];
      function setStatus(el, msg, state){ if(!el) return; el.textContent = msg; state? el.setAttribute('data-state', state):el.removeAttribute('data-state'); }
      function countWords(t){ t=(t||'').trim(); return t? t.split(/\s+/).filter(Boolean).length:0; }
      function fmt(n){ return `${n} word${n===1?'':'s'}`; }
      function broadcastNoStorage(){
        if (!storageAvailable) return;
        storageAvailable = false; storage = null;
        watchers.forEach(w => { w.cancel?.(); w.clearPending?.(); w.panel.classList.add('writing-panel--no-storage'); setStatus(w.statusEl,'Autosave unavailable — your writing stays only while this tab is open.','error'); });
      }

      panels.forEach((panel, i) => {
        const textarea = panel.querySelector('[data-writing-input]');
        const statusEl = panel.querySelector('[data-writing-status]');
        const countEl = panel.querySelector('[data-writing-count]');
        const resetBtn = panel.querySelector('[data-writing-reset]');
        if (!textarea || !statusEl || !countEl) return;

        const key = storagePrefix + (panel.getAttribute('data-storage-key') || textarea.id || i);
        let revertTimer=null, pending=null;
        const watcher = {
          panel, statusEl,
          cancel(){ if(revertTimer){clearTimeout(revertTimer); revertTimer=null;} },
          clearPending(){ if(pending){clearTimeout(pending); pending=null;} }
        };
        watchers.push(watcher);

        function updateStatus(msg,state,revert=false){
          setStatus(statusEl,msg,state); watcher.cancel();
          if (revert && storageAvailable && storage){
            revertTimer = setTimeout(()=>{ setStatus(statusEl,'Autosave ready.','muted'); revertTimer=null; },2200);
          }
        }
        function updateCount(){ countEl.textContent = fmt(countWords(textarea.value)); }
        function persist(){
          if (!storageAvailable || !storage) return;
          try { textarea.value ? storage.setItem(key, textarea.value) : storage.removeItem(key);
                updateStatus('Saved just now.','success',true);
          } catch { broadcastNoStorage(); }
        }
        function scheduleSave(){
          updateCount();
          if (!storageAvailable || !storage){ updateStatus('Autosave unavailable — your writing stays only while this tab is open.','error'); return; }
          updateStatus('Saving…','saving'); watcher.clearPending();
          pending = setTimeout(()=>{ pending=null; persist(); },400);
        }

        if (storageAvailable && storage){
          const stored = storage.getItem(key);
          if (typeof stored === 'string'){ textarea.value = stored; updateStatus('Restored from your last visit.','info',true); }
          else { updateStatus('Autosave ready.','muted'); }
        } else { panel.classList.add('writing-panel--no-storage'); updateStatus('Autosave unavailable — your writing stays only while this tab is open.','error'); }

        updateCount();
        textarea.addEventListener('input', scheduleSave);
        textarea.addEventListener('blur', ()=>{ watcher.clearPending(); persist(); });
        resetBtn?.addEventListener('click', ()=>{ watcher.clearPending(); textarea.value=''; try{ storage?.removeItem(key);}catch{ broadcastNoStorage(); } updateCount(); updateStatus('Cleared. Start fresh.','muted',true); textarea.focus(); });
      });
    })();
  </script>

  <!-- Game logic -->
  <script>
    (function(){
      const easyQuestions = [
        { q: "The Constitution names the Prime Minister.", a: "vibe", exp: "No. The words ‘Prime Minister’ are not in the Constitution." },
        { q: "The Constitution splits powers between the national government and the states.", a: "text", exp: "Yes. It lists what the national Parliament can make laws about." },
        { q: "The Constitution protects the environment.", a: "vibe", exp: "No. It doesn’t mention the environment or climate." },
        { q: "The Constitution creates the High Court.", a: "text", exp: "Yes. It sets up the High Court." },
        { q: "Australia has a big list of rights in the Constitution.", a: "vibe", exp: "No. There’s no general ‘Bill of Rights’." },
        { q: "The Constitution lets Parliament make marriage laws.", a: "text", exp: "Yes. Marriage is one of the listed topics (powers)." },
        { q: "The job ‘Prime Minister’ is a tradition, not written in the Constitution.", a: "text", exp: "Right. It’s a practice (a ‘convention’), not written in the words." }
      ];
      const standardQuestions = [
        { q: "The Prime Minister is mentioned in the Constitution.", a: "vibe", exp: "The Constitution does not mention the PM — it mostly covers Parliament, the Crown and the courts." },
        { q: "The Constitution sets out rules for dividing power between the states and federal government.", a: "text", exp: "Yes — division of powers is a core part of the document (e.g., s 51)." },
        { q: "Environmental protection is a key principle in the Constitution.", a: "vibe", exp: "No — the 1901 text doesn’t include environment or climate references." },
        { q: "It establishes the High Court of Australia.", a: "text", exp: "Correct — the Constitution creates the High Court and its role (Chapter III)." },
        { q: "It includes a Bill of Rights protecting free speech.", a: "vibe", exp: "No general Bill of Rights exists — only a few limited rights are in the text." },
        { q: "The Constitution allows the Commonwealth to make marriage laws.", a: "text", exp: "Yes — marriage is among the heads of power in section 51." }
      ];

      let current = 0, score = 0, useEasy = true;
      const gameEl = document.getElementById('game');
      const qEl = document.getElementById('question');
      const fEl = document.getElementById('feedback');
      const sEl = document.getElementById('score');
      const nextBtn = document.getElementById('nextBtn');

      const controls = document.createElement('div');
      controls.className = 'flex flex-wrap items-center justify-between gap-3 mb-4';
      controls.innerHTML = `
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="easyToggle" type="checkbox" class="h-4 w-4 accent-purple-600" checked>
          <span>Easy Mode</span>
        </label>
        <button id="speakBtn" class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm">🔊 Read aloud</button>
        <details class="rounded-lg border border-gray-200 px-3 py-2 text-sm">
          <summary class="cursor-pointer font-semibold">Vocab help</summary>
          <ul class="mt-2 list-disc list-inside space-y-1 text-gray-700">
            <li><strong>Constitution:</strong> the country’s main rule book</li>
            <li><strong>Parliament:</strong> the people who make national laws</li>
            <li><strong>High Court:</strong> the top court in Australia</li>
            <li><strong>Bill of Rights:</strong> a big list of rights (Australia doesn’t have a general one in the Constitution)</li>
            <li><strong>Division of powers:</strong> who does what: national vs states</li>
          </ul>
        </details>`;
      gameEl.prepend(controls);

      const easyToggle = document.getElementById('easyToggle');
      const speakBtn = document.getElementById('speakBtn');

      const btnVibe = Array.from(gameEl.querySelectorAll('button')).find(b => (b.getAttribute('onclick')||'').includes("answer('vibe'"));
      const btnText = Array.from(gameEl.querySelectorAll('button')).find(b => (b.getAttribute('onclick')||'').includes("answer('text'"));
      if (btnVibe) btnVibe.textContent = '💡 Idea (Vibe)';
      if (btnText) btnText.textContent = '📜 In the Constitution';

      function activeSet(){ return useEasy ? easyQuestions : standardQuestions; }

      function loadQuestion(){
        const arr = activeSet();
        const q = arr[current];
        qEl.textContent = q.q;
        fEl.textContent = '';
        nextBtn.classList.add('hidden');
        sEl.textContent = `Score: ${score}/${current}`;
      }

      window.answer = function(choice){
        const arr = activeSet();
        const q = arr[current];
        if (choice === q.a) { score++; fEl.innerHTML = `<span class="text-green-600 font-bold">✔ Correct!</span> ${q.exp}`; }
        else { fEl.innerHTML = `<span class="text-red-600 font-bold">✘ Incorrect.</span> ${q.exp}`; }
        nextBtn.classList.remove('hidden');
        sEl.textContent = `Score: ${score}/${current+1}`;
      }

      window.nextQuestion = function(){
        const arr = activeSet();
        current++;
        if (current < arr.length) { loadQuestion(); }
        else {
          qEl.textContent = 'Game Over! 🎉';
          fEl.textContent = `Your final score is ${score}/${arr.length}.`;
          nextBtn.textContent = 'Play Again';
          nextBtn.onclick = restart;
        }
      }

      function restart(){ current = 0; score = 0; nextBtn.textContent = 'Next →'; nextBtn.onclick = window.nextQuestion; loadQuestion(); }
      easyToggle.addEventListener('change', () => { useEasy = easyToggle.checked; restart(); });

      function speak(text){
        try {
          if (!('speechSynthesis' in window)) return;
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'en-AU';
          window.speechSynthesis.speak(u);
        } catch {}
      }
      speakBtn.addEventListener('click', () => { speak(qEl.textContent + '. ' + fEl.textContent); });

      loadQuestion();
    })();
  </script>

<script type="module">
// ========== Firebase (modular SDK via CDN) ==========
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import {
  getAuth,
  onAuthStateChanged,
  signOut,
  signInWithPopup,
  signInWithRedirect,
  getRedirectResult,
  GoogleAuthProvider
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  serverTimestamp,
  collection,
  query,
  orderBy,
  limit,
  getDocs
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

// ---- Config (public; do not hide) ----
const firebaseConfig = {
  apiKey: "AIzaSyBrFrkNcIq7LL7dMvpG3ZUgNsYXs6hBTQY",
  authDomain: "save-a9ea5.firebaseapp.com",
  projectId: "save-a9ea5",
  storageBucket: "save-a9ea5.firebasestorage.app",
  messagingSenderId: "266526082951",
  appId: "1:266526082951:web:dea4164197d3ff3f02f522"
};

// ---- Init ----
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---- Teacher allowlist ----
const TEACHERS = [
  'dmaher42@hotmail.com',
  'dmaher@mbhs.sa.edu.au',
  // 'your.name@mbhs.sa.edu.au',
];

// ---- UI refs ----
const loginBtnTop = document.getElementById('googleLoginTop');
const signOutTop = document.getElementById('signOutTop');
const googleBtn = document.getElementById('googleLogin');
const signOutBtn = document.getElementById('signOut');
const statusEl = document.getElementById('fbStatus');
const saveNowBtn = document.getElementById('saveNow');
const hintEl = document.getElementById('saveHint');
const nameInput = document.getElementById('studentName');
const classInput = document.getElementById('studentClass');

// ---- Helpers ----
const teacherSet = new Set(TEACHERS.map((e) => e.toLowerCase()));
const sessionStore = (() => {
  try {
    return window.sessionStorage;
  } catch (err) {
    console.warn('[auth] sessionStorage unavailable', err);
    return null;
  }
})();

const POPUP_FALLBACK_CODES = new Set([
  'auth/operation-not-supported-in-this-environment',
  'auth/popup-blocked',
  'auth/popup-closed-by-user',
  'auth/auth-domain-config-required'
]);
const AUTO_REDIRECT_KEY = 'mbhs_auto_redirect_tried';
const LOGIN_REDIRECTING_KEY = 'mbhs_login_redirecting';

function isTeacherEmail(email) {
  return teacherSet.has((email || '').toLowerCase());
}
function domainOK(email) {
  return (email || '').toLowerCase().endsWith('@mbhs.sa.edu.au');
}

function morphToSignedIn(email) {
  if (loginBtnTop) {
    loginBtnTop.dataset.state = 'signed-in';
    loginBtnTop.className = 'inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-600 text-white font-semibold cursor-default';
    loginBtnTop.innerHTML = '✓ Signed in';
    loginBtnTop.title = email || 'Signed in';
    loginBtnTop.setAttribute('disabled', 'true');
  }
  if (googleBtn) {
    googleBtn.textContent = 'Signed in';
    googleBtn.setAttribute('disabled', 'true');
  }
}
function morphToSignIn() {
  if (loginBtnTop) {
    delete loginBtnTop.dataset.state;
    loginBtnTop.className = 'px-3 py-2 rounded-lg bg-brand-600 text-white font-semibold hover:opacity-90';
    loginBtnTop.textContent = 'Sign in with Google';
    loginBtnTop.removeAttribute('disabled');
    loginBtnTop.removeAttribute('title');
  }
  if (googleBtn) {
    googleBtn.textContent = 'Sign in with Google';
    googleBtn.removeAttribute('disabled');
  }
}

function setLoginButtonsLoading(loading) {
  const buttons = [loginBtnTop, googleBtn];
  buttons.forEach((btn) => {
    if (!btn) return;
    if (loading) {
      btn.dataset.loading = '1';
      btn.classList.add('opacity-80', 'cursor-wait');
      btn.setAttribute('disabled', 'true');
    } else {
      btn.classList.remove('opacity-80', 'cursor-wait');
      delete btn.dataset.loading;
      if (btn === loginBtnTop) {
        if (loginBtnTop?.dataset.state !== 'signed-in') {
          loginBtnTop.removeAttribute('disabled');
        }
      } else if (!auth.currentUser) {
        btn.removeAttribute('disabled');
      }
    }
  });
}

function setFlag(key, value) {
  if (!sessionStore) return;
  try {
    if (value) {
      sessionStore.setItem(key, '1');
    } else {
      sessionStore.removeItem(key);
    }
  } catch (err) {
    console.warn('[auth] sessionStorage write failed', err);
  }
}
function getFlag(key) {
  if (!sessionStore) return false;
  try {
    return sessionStore.getItem(key) === '1';
  } catch (err) {
    console.warn('[auth] sessionStorage read failed', err);
    return false;
  }
}
function createProvider() {
  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ hd: 'mbhs.sa.edu.au', prompt: 'select_account' });
  return provider;
}
function isRedirecting() {
  return getFlag(LOGIN_REDIRECTING_KEY);
}
function markRedirecting(flag) {
  setFlag(LOGIN_REDIRECTING_KEY, flag);
}
function hasAutoRedirected() {
  return getFlag(AUTO_REDIRECT_KEY);
}
function markAutoRedirected() {
  setFlag(AUTO_REDIRECT_KEY, true);
}

function maybeAutoLogin() {
  if (auth.currentUser) return;
  if (!sessionStore) {
    console.log('[auth] sessionStorage unavailable; skipping auto sign-in redirect');
    return;
  }
  if (hasAutoRedirected()) {
    console.log('[auth] auto sign-in redirect already attempted this session');
    return;
  }
  console.log('[auth] auto redirect sign-in triggered');
  markAutoRedirected();
  markRedirecting(true);
  const provider = createProvider();
  signInWithRedirect(auth, provider).catch((err) => {
    console.warn('[auth] auto redirect failed', err?.code, err?.message);
    markRedirecting(false);
  });
}

async function startLoginFlow() {
  if (auth.currentUser) {
    console.log('[auth] startLoginFlow skipped — already signed in');
    return;
  }
  if (loginBtnTop?.dataset.loading === '1' || googleBtn?.dataset.loading === '1') {
    return;
  }
  console.log('[auth] start login (popup first)');
  setLoginButtonsLoading(true);
  const provider = createProvider();
  let triggeredRedirect = false;
  try {
    await signInWithPopup(auth, provider);
    console.log('[auth] popup sign-in success');
  } catch (error) {
    console.warn('[auth] popup sign-in failed', error?.code, error?.message);
    if (POPUP_FALLBACK_CODES.has(error?.code)) {
      console.log('[auth] falling back to redirect sign-in');
      triggeredRedirect = true;
      markRedirecting(true);
      try {
        await signInWithRedirect(auth, provider);
      } catch (redirectErr) {
        triggeredRedirect = false;
        markRedirecting(false);
        console.error('[auth] redirect sign-in failed', redirectErr?.code, redirectErr?.message);
        alert('Sign-in failed. Please try again or contact your teacher.');
      }
      return;
    }
    alert('Sign-in failed. Please try again or contact your teacher.');
  } finally {
    if (!triggeredRedirect) {
      setLoginButtonsLoading(false);
    }
  }
}

function handleSignOut() {
  console.log('[auth] sign-out requested');
  signOut(auth).catch((err) => console.error('[auth] sign-out error', err));
}

loginBtnTop?.addEventListener('click', startLoginFlow);
googleBtn?.addEventListener('click', startLoginFlow);
signOutTop?.addEventListener('click', handleSignOut);
signOutBtn?.addEventListener('click', handleSignOut);
window.startGoogleSignIn = startLoginFlow;

getRedirectResult(auth)
  .then((result) => {
    if (result?.user) {
      console.log('[auth] redirect result received', result.user.email);
    } else {
      console.log('[auth] no redirect user result');
    }
  })
  .catch((err) => {
    if (err?.code === 'auth/no-auth-event') {
      console.log('[auth] no auth event on redirect result');
    } else {
      console.error('[auth] redirect result error', err);
    }
  })
  .finally(() => {
    markRedirecting(false);
  });

// ---- Collectors from page (keep selectors as in your page) ----
function collectWritingPanels() {
  const out = {};
  document.querySelectorAll('[data-writing-panel]').forEach((panel, i) => {
    const key = panel.getAttribute('data-storage-key') || `panel_${i}`;
    const text = panel.querySelector('[data-writing-input]')?.value?.trim() || '';
    out[key] = text;
  });
  return out;
}
function getGameScoreObj() {
  let score = null;
  let total = null;
  const sEl = document.getElementById('score');
  if (sEl?.textContent) {
    const m = sEl.textContent.match(/(\d+)\s*\/\s*(\d+)/);
    if (m) {
      score = +m[1];
      total = +m[2];
    }
  }
  return { score, total };
}

// ---- Save bundle to Firestore ----
async function saveBundle() {
  const user = auth.currentUser;
  if (!user) {
    if (hintEl) hintEl.textContent = 'Please sign in with @mbhs.sa.edu.au';
    return;
  }
  const payload = {
    uid: user.uid,
    email: user.email || null,
    name: nameInput?.value.trim() || null,
    class: classInput?.value.trim() || null,
    lesson: 'vibe-vs-text',
    panels: collectWritingPanels(),
    game: getGameScoreObj(),
    updatedAt: serverTimestamp()
  };
  await setDoc(doc(db, 'responses', user.uid), payload, { merge: true });
  if (hintEl) {
    hintEl.textContent = 'Saved just now.';
    setTimeout(() => {
      if (hintEl.textContent === 'Saved just now.') {
        hintEl.textContent = 'Autosaves while you type.';
      }
    }, 2000);
  }
}

// ---- Debounced autosave ----
let t = null;
function scheduleSave() {
  clearTimeout(t);
  t = setTimeout(saveBundle, 1000);
}
document.querySelectorAll('[data-writing-input]').forEach((el) => {
  el.addEventListener('input', scheduleSave);
  el.addEventListener('blur', saveBundle);
});
document.getElementById('nextBtn')?.addEventListener('click', scheduleSave);
saveNowBtn?.addEventListener('click', saveBundle);

// ---- Auth guard + dashboard wiring ----
onAuthStateChanged(auth, async (user) => {
  console.log('[auth] state changed', user?.email || 'none');
  setLoginButtonsLoading(false);

  if (!user) {
    morphToSignIn();
    signOutTop?.classList.add('hidden');
    signOutBtn?.classList.add('hidden');
    if (statusEl) statusEl.textContent = 'Not signed in';
    if (hintEl) hintEl.textContent = 'Please sign in with @mbhs.sa.edu.au';
    if (!isRedirecting()) {
      maybeAutoLogin();
    } else {
      console.log('[auth] redirect in progress — skipping auto sign-in');
    }
    window.dispatchEvent(new CustomEvent('auth-ready', { detail: { user: null } }));
    return;
  }

  const rawEmail = user.email || '';
  const email = rawEmail.toLowerCase();
  const teacher = isTeacherEmail(email);
  if (!domainOK(email) && !teacher) {
    console.warn('[auth] rejecting non-MBHS account', email);
    alert('Please sign in with your @mbhs.sa.edu.au account.');
    await signOut(auth);
    return;
  }

  console.log('[auth] signed in', rawEmail, teacher ? '(teacher)' : '');
  morphToSignedIn(rawEmail);
  signOutTop?.classList.remove('hidden');
  signOutBtn?.classList.remove('hidden');
  if (statusEl) statusEl.textContent = `Signed in: ${rawEmail || 'account'}`;
  if (hintEl) hintEl.textContent = 'Autosaves while you type.';

  // Prefill fields if prior data exists
  try {
    const snap = await getDoc(doc(db, 'responses', user.uid));
    const data = snap.exists() ? snap.data() : null;
    if (data) {
      if (data.name && !nameInput?.value) nameInput.value = data.name;
      if (data.class && !classInput?.value) classInput.value = data.class;
    }
  } catch (e) {
    console.debug('[auth] prefill skipped', e);
  }

  // Teacher dashboard (optional)
  const dash = document.getElementById('teacher-dash');
  if (dash) {
    if (teacher) {
      dash.classList.remove('hidden');
      const dashInfo = document.getElementById('dashInfo');
      const dashRows = document.getElementById('dashRows');
      if (dashInfo) dashInfo.textContent = 'Showing latest 50 responses';
      if (dashRows) {
        dashRows.innerHTML = '';
        const q = query(collection(db, 'responses'), orderBy('updatedAt', 'desc'), limit(50));
        const qs = await getDocs(q);
        qs.forEach((docSnap) => {
          const d = docSnap.data();
          const when = d.updatedAt?.toDate ? d.updatedAt.toDate().toLocaleString() : '—';
          const score = d.game?.score != null && d.game?.total != null ? `${d.game.score}/${d.game.total}` : '—';
          const name = d.name || '—';
          const klass = d.class || '—';
          const mail = d.email || '—';
          const link = `data:text/plain,` + encodeURIComponent(
            `Name: ${name}\nClass: ${klass}\nEmail: ${mail}\nUpdated: ${when}\nScore: ${score}\n\nPanels:\n` +
            Object.entries(d.panels || {}).map(([k, v]) => `- ${k}:\n${(v || '').trim()}\n`).join('\n')
          );
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 align-top">${name}</td>
            <td class="p-2 align-top">${klass}</td>
            <td class="p-2 align-top">${mail}</td>
            <td class="p-2 align-top">${when}</td>
            <td class="p-2 align-top">${score}</td>
            <td class="p-2 align-top"><a class="underline" href="${link}" download="${(name || 'student').replace(/\s+/g, '_')}_submission.txt">Download</a></td>
          `;
          dashRows?.appendChild(tr);
        });
      }
    } else {
      dash.classList.add('hidden');
    }
  }

  // Save once on sign-in to create/update doc
  saveBundle();

  window.dispatchEvent(new CustomEvent('auth-ready', { detail: { user } }));
});
</script>

<script type="module">
  // Firebase (re-use your app if already initialized)
  import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import {
    getFirestore, doc, getDoc, setDoc, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import {
    getStorage, ref, uploadBytes, getDownloadURL, listAll, deleteObject
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

  // === Your config (public) — keep consistent with the rest of your page ===
  const firebaseConfig = {
    apiKey: "AIzaSyBrFrkNcIq7LL7dMvpG3ZUgNsYXs6hBTQY",
    authDomain: "save-a9ea5.firebaseapp.com",
    projectId: "save-a9ea5",
    storageBucket: "save-a9ea5.firebasestorage.app",
    messagingSenderId: "266526082951",
    appId: "1:266526082951:web:dea4164197d3ff3f02f522"
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ====== Configure your Unit + Weeks here (edit labels/prompts freely) ======
  const UNIT = {
    id: 'civics-constitution-2025',
    title: "Civics: Australia’s Constitution (2025)",
    weeks: [
      {
        id: 'wk1', label: 'Week 1 — Vibe vs Text',
        prompts: [
          { id: 'sepPowers', label: 'Five-Finger: Separation of Powers' },
          { id: 'divPowers', label: 'Five-Finger: Division of Powers' },
          { id: 'ruleOfLaw', label: 'Five-Finger: Rule of Law' },
          { id: 'repResp',   label: 'Five-Finger: Representative & Responsible Government' },
          { id: 'rights',    label: 'Five-Finger: Rights in the Constitution' },
          { id: 'reflection',label: 'Reflection — What surprised you? What’s missing?' }
        ]
      },
      {
        id: 'wk2', label: 'Week 2 — How the High Court interprets the Constitution',
        prompts: [
          { id: 'caseStudy', label: 'Case study: What happened and why?' },
          { id: 'evidence',  label: 'Evidence from sources (quotes/notes)' },
          { id: 'reflection',label: 'Reflection — What did this change or clarify?' }
        ]
      },
      {
        id: 'wk3', label: 'Week 3 — Comparing Constitutions (AUS vs another)',
        prompts: [
          { id: 'similar',   label: 'Similarities' },
          { id: 'different', label: 'Differences' },
          { id: 'impact',    label: 'Impact on people/government' }
        ]
      },
      {
        id: 'wk4', label: 'Week 4 — Rights Debate',
        prompts: [
          { id: 'pros',      label: 'Arguments for a Bill of Rights in AUS' },
          { id: 'cons',      label: 'Arguments against' },
          { id: 'position',  label: 'Your position + reasons' }
        ]
      },
      {
        id: 'wk5', label: 'Week 5 — Assessment Prep',
        prompts: [
          { id: 'thesis',    label: 'Thesis / main claim' },
          { id: 'evidence',  label: 'Key evidence' },
          { id: 'counter',   label: 'Counterargument + rebuttal' }
        ]
      },
      {
        id: 'wk6', label: 'Week 6 — Final Reflection',
        prompts: [
          { id: 'lookBack',  label: 'How did your understanding change?' },
          { id: 'strengths', label: 'Your strengths in this unit' },
          { id: 'goals',     label: 'Goals for next unit' }
        ]
      }
    ]
  };

  // ====== Elements ======
  const statusEl = document.getElementById('portfolioStatus');
  const unitSel  = document.getElementById('pfUnit');
  const weekTabs = document.getElementById('pfWeeks');
  const promptsEl= document.getElementById('pfPrompts');
  const fileInput= document.getElementById('pfFile');
  const uploadBtn= document.getElementById('pfUpload');
  const filesList= document.getElementById('pfFiles');

  // ====== State ======
  let currentUser = null;
  let currentWeekId = localStorage.getItem('pf_week') || UNIT.weeks[0].id;

  // ====== Helpers ======
  const weekById = id => UNIT.weeks.find(w => w.id === id);
  const weekDoc = (uid, weekId) => doc(db, 'portfolios', uid, 'units', UNIT.id, 'weeks', weekId);
  const storageKey = (uid, weekId, name) => `uploads/${uid}/${UNIT.id}/${weekId}/${Date.now()}_${name.replace(/\s+/g,'_')}`;

  function renderWeekTabs() {
    weekTabs.innerHTML = '';
    UNIT.weeks.forEach(w => {
      const btn = document.createElement('button');
      btn.className = `px-3 py-1 rounded-full border ${w.id===currentWeekId ? 'bg-blue-600 text-white' : 'hover:bg-slate-50'}`;
      btn.textContent = w.label;
      btn.onclick = () => {
        currentWeekId = w.id;
        localStorage.setItem('pf_week', currentWeekId);
        renderWeekTabs();
        loadWeek();
      };
      weekTabs.appendChild(btn);
    });
  }

  function mountPrompts(data) {
    promptsEl.innerHTML = '';
    const week = weekById(currentWeekId);
    week.prompts.forEach(p => {
      const wrap = document.createElement('div');
      wrap.className = 'bg-slate-50 border border-slate-200 rounded-lg p-3';
      wrap.innerHTML = `
        <label class="block text-sm font-semibold mb-1">${p.label}</label>
        <textarea data-prompt="${p.id}" rows="4"
          class="w-full rounded-lg border border-slate-300 p-2"
          placeholder="Type here..."></textarea>
      `;
      const ta = wrap.querySelector('textarea');
      ta.value = (data?.panels?.[p.id]) || '';
      ta.addEventListener('input', debounce(saveWeek, 800));
      ta.addEventListener('blur', saveWeek);
      promptsEl.appendChild(wrap);
    });
  }

  async function loadWeek() {
    filesList.innerHTML = '';
    if (!currentUser) return;
    const ref = weekDoc(currentUser.uid, currentWeekId);
    const snap = await getDoc(ref);
    const data = snap.exists() ? snap.data() : null;
    mountPrompts(data);
    await refreshFiles();
  }

  async function saveWeek() {
    if (!currentUser) return;
    const panels = {};
    promptsEl.querySelectorAll('textarea[data-prompt]').forEach(ta => {
      panels[ta.getAttribute('data-prompt')] = ta.value.trim();
    });
    const ref = weekDoc(currentUser.uid, currentWeekId);
    await setDoc(ref, {
      uid: currentUser.uid,
      unitId: UNIT.id,
      weekId: currentWeekId,
      panels,
      updatedAt: serverTimestamp()
    }, { merge: true });
    statusEl.textContent = 'Saved';
    setTimeout(()=> statusEl.textContent = 'Saved (signed in)', 1500);
  }

  // Files
  async function refreshFiles() {
    filesList.innerHTML = '';
    const base = `uploads/${currentUser.uid}/${UNIT.id}/${currentWeekId}`;
    const dirRef = ref(storage, base);
    try {
      const listing = await listAll(dirRef);
      if (listing.items.length === 0) {
        filesList.innerHTML = '<li class="text-slate-500">No files yet.</li>';
        return;
      }
      for (const item of listing.items) {
        const url = await getDownloadURL(item);
        const li = document.createElement('li');
        li.innerHTML = `
          <a class="underline" target="_blank" rel="noopener" href="${url}">${item.name}</a>
          <button class="ml-2 text-xs underline text-rose-600" data-del>Delete</button>
        `;
        li.querySelector('[data-del]').onclick = async () => {
          if (!confirm('Delete this file from your portfolio?')) return;
          await deleteObject(item);
          await refreshFiles();
        };
        filesList.appendChild(li);
      }
    } catch (e) {
      filesList.innerHTML = '<li class="text-rose-600">Can’t list files (are Storage rules set?)</li>';
      console.error(e);
    }
  }

  uploadBtn?.addEventListener('click', async () => {
    if (!currentUser) return alert('Sign in first.');
    const files = fileInput.files;
    if (!files || !files.length) return alert('Choose one or more files first.');
    for (const f of files) {
      const path = storageKey(currentUser.uid, currentWeekId, f.name);
      const r = ref(storage, path);
      await uploadBytes(r, f);
    }
    fileInput.value = '';
    await refreshFiles();
  });

  // Tiny debounce
  function debounce(fn, ms) {
    let t; return (...a) => { clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
  }

  // Auth link-up (expects you already wired Google sign-in somewhere else on the page)
  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;
    if (!user) {
      statusEl.textContent = 'Not signed in';
      promptsEl.innerHTML = '<div class="text-sm text-slate-600">Sign in with your school account to start/continue your portfolio.</div>';
      return;
    }
    statusEl.textContent = 'Saved (signed in)';
    unitSel.value = UNIT.id;
    renderWeekTabs();
    await loadWeek();
  });

  // if you add more units later, you can read unitSel.value and swap UNIT dynamically.
</script>


</body>
</html>
